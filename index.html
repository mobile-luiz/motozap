<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotoZap - Sua corrida r√°pida no interior</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK atualizado -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" id="manifest">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        /* Header */
        header {
            background: linear-gradient(to right, #FF6600, #FF3300);
            color: white;
            padding: 20px 0;
            text-align: center;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: 0 4px 12px rgba(255, 102, 0, 0.3);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .logo i {
            font-size: 2.5rem;
            margin-right: 15px;
        }

        .logo h1 {
            font-size: 2.2rem;
            letter-spacing: 1px;
        }

        .tagline {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        /* Install App Banner */
        .install-banner {
            background: linear-gradient(to right, #4CAF50, #2E7D32);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .install-banner.hidden {
            display: none;
        }

        .install-banner button {
            background: white;
            color: #2E7D32;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .install-banner button:hover {
            background: #f0f0f0;
        }

        /* Main Content */
        .user-options {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin: 40px 0;
        }

        .option-card {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            border-left: 6px solid #FF6600;
        }

        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .option-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .option-header i {
            font-size: 2rem;
            color: #FF6600;
            margin-right: 15px;
        }

        .option-header h2 {
            font-size: 1.8rem;
            color: #333;
        }

        .option-description {
            color: #666;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .btn-action {
            background-color: #FF6600;
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
            width: 100%;
        }

        .btn-action i {
            margin-right: 10px;
        }

        .btn-action:hover {
            background-color: #FF3300;
        }

        /* WhatsApp Button */
        .whatsapp-btn {
            background-color: #25D366;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            width: 100%;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        }

        .whatsapp-btn:hover {
            background-color: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(37, 211, 102, 0.4);
        }

        .whatsapp-btn i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        /* Communication Section */
        .communication-section {
            background-color: #FFF8F0;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px dashed #FF9900;
            text-align: center;
        }

        .communication-section h4 {
            color: #FF6600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .phone-info {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #25D366;
        }

        .phone-info p {
            margin: 5px 0;
            font-size: 1rem;
        }

        .phone-number {
            font-size: 1.2rem !important;
            font-weight: bold;
            color: #333;
            margin: 10px 0 !important;
        }

        .communication-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .communication-actions .whatsapp-btn {
            flex: 1;
            min-width: 200px;
        }

        .call-btn {
            background-color: #FF6600;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            text-decoration: none;
            flex: 1;
            min-width: 200px;
        }

        .call-btn:hover {
            background-color: #FF3300;
            transform: translateY(-2px);
        }

        .call-btn i {
            margin-right: 10px;
        }

        /* Info Section */
        .info-box {
            background-color: #FFF8F0;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border: 1px dashed #FF9900;
        }

        .info-box h3 {
            color: #FF6600;
            margin-bottom: 15px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
        }

        .info-box h3 i {
            margin-right: 10px;
        }

        .info-box p {
            color: #666;
            line-height: 1.6;
            font-size: 1.05rem;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 25px 0;
            color: #666;
            margin-top: auto;
            border-top: 1px solid #eee;
        }

        .footer-logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #FF6600;
            margin-bottom: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #666;
        }

        .close-modal:hover {
            color: #FF3300;
        }

        .modal h2 {
            color: #FF6600;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-control:focus {
            border-color: #FF6600;
            outline: none;
        }

        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status-success {
            background-color: #e7f7ef;
            color: #0a5c36;
            border-left: 4px solid #0a5c36;
        }

        .status-error {
            background-color: #fde8e8;
            color: #c53030;
            border-left: 4px solid #c53030;
        }

        .status-info {
            background-color: #e8f4fd;
            color: #2c5282;
            border-left: 4px solid #2c5282;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .user-info {
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s;
            padding: 10px;
            border-radius: 10px;
        }

        .user-info:hover {
            transform: translateY(-2px);
            background-color: rgba(255, 102, 0, 0.1);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #FF6600;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .logout-btn {
            background-color: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background-color: #eee;
        }

        /* Ride Status */
        .ride-status-box {
            background-color: #FFF8F0;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid #FF9900;
        }

        .ride-details {
            margin: 15px 0;
        }

        .ride-detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }

        .driver-card {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #FF6600;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        /* Mobile Notifications Container */
        .mobile-notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            width: 300px;
            max-width: 90vw;
        }

        .mobile-notification {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-left: 5px solid #FF6600;
            animation: slideInRight 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .mobile-notification.hiding {
            animation: slideOutRight 0.3s ease forwards;
        }

        .mobile-notification.new-ride {
            border-left-color: #FF3300;
            background: linear-gradient(to right, #FFF8F0, white);
        }

        .mobile-notification.ride-accepted {
            border-left-color: #0a5c36;
            background: linear-gradient(to right, #e7f7ef, white);
        }

        .mobile-notification.ride-started {
            border-left-color: #2c5282;
            background: linear-gradient(to right, #e8f4fd, white);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: bold;
            color: #FF6600;
            font-size: 1rem;
        }

        .notification-time {
            font-size: 0.8rem;
            color: #999;
        }

        .notification-body {
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 10px;
        }

        .notification-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .notification-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            flex: 1;
        }

        .notification-btn.accept {
            background: #0a5c36;
            color: white;
        }

        .notification-btn.decline {
            background: #dc3545;
            color: white;
        }

        .notification-btn.view {
            background: #FF6600;
            color: white;
        }

        .notification-btn.whatsapp {
            background: #25D366;
            color: white;
        }

        .notification-close {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1rem;
        }

        /* Notification Bell */
        .notification-bell {
            position: relative;
            margin-right: 20px;
            cursor: pointer;
        }

        .notification-bell i {
            font-size: 1.5rem;
            color: #FF6600;
        }

        .notification-bell:hover i {
            color: #FF3300;
        }

        .badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #FF3300;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Alert for new ride */
        .new-ride-alert {
            background-color: #FFF8F0;
            border: 2px solid #FF6600;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 102, 0, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 102, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 102, 0, 0);
            }
        }

        /* PWA Install Button */
        .pwa-install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #FF6600;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 102, 0, 0.3);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .pwa-install-btn:hover {
            background: #FF3300;
        }

        /* Test Notification Button */
        .test-notification-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: #2c5282;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(44, 82, 130, 0.3);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .test-notification-btn:hover {
            background: #1a365d;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-btn.active {
            background-color: #FF6600;
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background-color: #f5f5f5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Profile Section */
        .profile-section {
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .profile-header h2 {
            color: #FF6600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-profile {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 50%;
        }

        .close-profile:hover {
            background-color: #f5f5f5;
            color: #FF3300;
        }

        .profile-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            border-color: #FF6600;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 102, 0, 0.1);
        }

        .form-control[readonly] {
            background-color: #f9f9f9;
            color: #666;
            cursor: not-allowed;
        }

        .password-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #2c5282;
        }

        .password-section h4 {
            color: #2c5282;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .form-buttons .btn-action {
            flex: 1;
            margin: 0;
        }

        .cancel-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
            flex: 1;
        }

        .cancel-btn:hover {
            background-color: #545b62;
        }

        /* Bot√£o de perfil */
        .profile-btn {
            background-color: #2c5282;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .profile-btn:hover {
            background-color: #1a365d;
            transform: translateY(-2px);
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            .logo h1 {
                font-size: 1.8rem;
            }
            
            .option-card {
                padding: 20px;
            }
            
            .option-header h2 {
                font-size: 1.5rem;
            }
            
            .mobile-notifications {
                top: 10px;
                right: 10px;
                width: calc(100vw - 20px);
            }
            
            .pwa-install-btn {
                bottom: 70px;
                right: 15px;
            }
            
            .test-notification-btn {
                bottom: 130px;
                right: 15px;
            }
            
            .communication-actions {
                flex-direction: column;
            }
            
            .communication-actions .whatsapp-btn,
            .communication-actions .call-btn {
                min-width: 100%;
            }
            
            .form-buttons {
                flex-direction: column;
            }
            
            .profile-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .close-profile {
                align-self: flex-end;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .user-info {
                width: 100%;
            }
            
            .tab-navigation {
                flex-direction: column;
            }
            
            .tab-btn {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Notifications Container -->
    <div id="mobileNotifications" class="mobile-notifications"></div>

    <!-- Install App Banner -->
    <div id="installBanner" class="install-banner hidden">
        <div>
            <strong>üì± Instalar App MotoZap</strong>
            <p style="margin-top: 5px; font-size: 0.9rem;">Tenha notifica√ß√µes push e acesso r√°pido!</p>
        </div>
        <button id="installBtn">
            <i class="fas fa-download"></i> Instalar
        </button>
    </div>

    <!-- Main Screen -->
    <div id="mainScreen" class="container">
        <header>
            <div class="logo">
                <i class="fas fa-motorcycle"></i>
                <h1>MOTOZAP</h1>
            </div>
            <p class="tagline">Sua corrida r√°pida no interior</p>
        </header>

        <main>
            <div class="user-options">
                <!-- Passenger Option -->
                <div class="option-card" id="passengerOption">
                    <div class="option-header">
                        <i class="fas fa-user"></i>
                        <h2>Sou Passageiro</h2>
                    </div>
                    <p class="option-description">
                        Quero pedir uma moto agora para me levar ao meu destino com rapidez e seguran√ßa.
                    </p>
                    <button class="btn-action" id="passengerBtn">
                        <i class="fas fa-motorcycle"></i> Pedir uma Moto
                    </button>
                </div>

                <!-- Driver Option -->
                <div class="option-card" id="driverOption">
                    <div class="option-header">
                        <i class="fas fa-helmet-safety"></i>
                        <h2>Sou Piloto</h2>
                    </div>
                    <p class="option-description">
                        Quero realizar corridas e aumentar minha renda transportando passageiros pela cidade.
                    </p>
                    <button class="btn-action" id="driverBtn">
                        <i class="fas fa-road"></i> Realizar Corridas
                    </button>
                </div>
            </div>

            <div class="info-box">
                <h3><i class="fas fa-info-circle"></i> Importante</h3>
                <p>O valor da corrida √© combinado <strong>diretamente com o piloto</strong>, garantindo flexibilidade e negocia√ß√£o justa para ambos.</p>
                <p style="margin-top: 10px;"><strong>MotoZap</strong> - O motot√°xi do interior</p>
            </div>
        </main>

        <footer>
            <div class="footer-logo">MotoZap</div>
            <p>Conectando passageiros e pilotos no interior</p>
            <p style="margin-top: 10px; font-size: 0.9rem;">¬© 2023 MotoZap - Todos os direitos reservados</p>
        </footer>
    </div>

    <!-- Login/Register Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal">&times;</span>
            <h2 id="modalTitle">Entrar no MotoZap</h2>
            
            <div id="statusMessage" class="status-message"></div>
            
            <form id="authForm">
                <div class="form-group">
                    <label for="email">E-mail</label>
                    <input type="email" id="email" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" class="form-control" required minlength="6">
                </div>
                
                <div class="form-group" id="nameField" style="display: none;">
                    <label for="name">Nome Completo</label>
                    <input type="text" id="name" class="form-control" required>
                </div>
                
                <div class="form-group" id="phoneField" style="display: none;">
                    <label for="phone">Telefone</label>
                    <input type="tel" id="phone" class="form-control" placeholder="(11) 99999-9999" required>
                </div>
                
                <div class="form-group" id="vehicleField" style="display: none;">
                    <label for="vehicle">Placa da Moto</label>
                    <input type="text" id="vehicle" class="form-control" placeholder="ABC-1234">
                </div>
                
                <button type="submit" class="btn-action" id="authSubmit">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
            </form>
            
            <p style="margin-top: 20px; text-align: center;">
                <a href="#" id="toggleAuthMode">N√£o tem uma conta? Cadastre-se</a>
            </p>
        </div>
    </div>

    <!-- Dashboard (for logged in users) -->
    <div id="dashboardScreen" class="container dashboard">
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="dashboard">
                <i class="fas fa-home"></i> Dashboard
            </button>
            <button class="tab-btn" data-tab="profile">
                <i class="fas fa-user-edit"></i> Perfil
            </button>
            <button class="tab-btn" data-tab="history">
                <i class="fas fa-history"></i> Hist√≥rico
            </button>
        </div>

        <div class="dashboard-header">
            <div class="user-info" id="userProfileBtn">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                    <h3 id="userName">Usu√°rio</h3>
                    <p id="userRole">Papel</p>
                </div>
            </div>
            <div style="display: flex; align-items: center;">
                <!-- Notification Bell (only for drivers) -->
                <div id="notificationBell" class="notification-bell" style="display: none;">
                    <i class="fas fa-bell"></i>
                    <span id="notificationBadge" class="badge" style="display: none;">0</span>
                </div>
                <button class="profile-btn" id="profileBtn">
                    <i class="fas fa-user-edit"></i> Perfil
                </button>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </div>
        
        <!-- Dashboard Tab Content -->
        <div id="dashboardTab" class="tab-content active">
            <div id="passengerDashboard" style="display: none;">
                <h2 style="color: #FF6600; margin-bottom: 20px;">Buscar Corrida</h2>
                <div class="option-card">
                    <div class="option-header">
                        <i class="fas fa-map-marker-alt"></i>
                        <h2>Solicitar Corrida</h2>
                    </div>
                    <p class="option-description">
                        Informe seu destino e encontraremos um piloto dispon√≠vel para te atender.
                    </p>
                    <div class="form-group">
                        <label for="pickupLocation">Local de Partida</label>
                        <input type="text" id="pickupLocation" class="form-control" placeholder="Ex: Av. Paulista, 1000" value="Centro da Cidade">
                    </div>
                    <div class="form-group">
                        <label for="destination">Destino</label>
                        <input type="text" id="destination" class="form-control" placeholder="Ex: Jardim Bot√¢nico" value="Bairro Residencial">
                    </div>
                    <div class="form-group">
                        <label for="ridePrice">Valor Sugerido (R$)</label>
                        <input type="number" id="ridePrice" class="form-control" placeholder="20.00" value="15" min="5" step="0.01">
                    </div>
                    <button class="btn-action" id="requestRideBtn">
                        <i class="fas fa-search"></i> Buscar Piloto
                    </button>
                </div>
                
                <div id="rideStatus" class="ride-status-box" style="display: none;">
                    <h3><i class="fas fa-spinner fa-spin" id="rideStatusIcon"></i> <span id="rideStatusTitle">Status da Corrida</span></h3>
                    <div id="rideDetails">
                        <!-- Ride details will be inserted here -->
                    </div>
                    
                    <!-- WhatsApp Communication Section (shown when ride is accepted) -->
                    <div id="whatsappSection" class="communication-section" style="display: none;">
                        <h4><i class="fab fa-whatsapp"></i> Falar com o Piloto</h4>
                        <div class="phone-info">
                            <p><strong>Piloto:</strong> <span id="driverContactName">N√£o informado</span></p>
                            <p class="phone-number"><i class="fas fa-phone"></i> <span id="driverPhoneNumber">N√£o informado</span></p>
                            <p><small>Clique no bot√£o abaixo para conversar no WhatsApp</small></p>
                        </div>
                        <div class="communication-actions">
                            <a id="whatsappPassengerBtn" class="whatsapp-btn" target="_blank">
                                <i class="fab fa-whatsapp"></i> Falar no WhatsApp
                            </a>
                            <a id="callPassengerBtn" class="call-btn">
                                <i class="fas fa-phone"></i> Ligar
                            </a>
                        </div>
                    </div>
                    
                    <div id="rideActions" style="margin-top: 20px;">
                        <button class="btn-action" id="cancelRideBtn" style="background-color: #dc3545;">
                            <i class="fas fa-times"></i> Cancelar Corrida
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="driverDashboard" style="display: none;">
                <h2 style="color: #FF6600; margin-bottom: 20px;">Painel do Piloto</h2>
                
                <div class="option-card">
                    <div class="option-header">
                        <i class="fas fa-road"></i>
                        <h2>Disponibilidade</h2>
                    </div>
                    <p class="option-description">
                        Alterne sua disponibilidade para receber solicita√ß√µes de corrida.
                    </p>
                    <div style="text-align: center; margin: 20px 0;">
                        <button class="btn-action" id="toggleAvailabilityBtn" style="width: auto; padding: 15px 30px;">
                            <i class="fas fa-power-off"></i> <span id="availabilityText">Estou Dispon√≠vel</span>
                        </button>
                    </div>
                    <p id="availabilityStatus" style="text-align: center; font-weight: bold; color: #dc3545;">
                        Status: Indispon√≠vel
                    </p>
                </div>
                
                <div id="activeRideRequests" class="info-box" style="margin-top: 20px;">
                    <h3><i class="fas fa-bell"></i> Solicita√ß√µes de Corrida</h3>
                    <div id="rideRequestsList">
                        <!-- Ride requests will be inserted here -->
                    </div>
                    <p id="noRequestsMessage">Nenhuma solicita√ß√£o de corrida no momento. Fique dispon√≠vel para receber pedidos.</p>
                </div>
                
                <div id="activeRide" class="ride-status-box" style="display: none;">
                    <h3><i class="fas fa-motorcycle"></i> Corrida Ativa</h3>
                    <div id="activeRideDetails">
                        <!-- Active ride details will be inserted here -->
                    </div>
                    
                    <!-- WhatsApp Communication Section (shown when ride is accepted) -->
                    <div id="whatsappDriverSection" class="communication-section" style="display: none;">
                        <h4><i class="fab fa-whatsapp"></i> Falar com o Passageiro</h4>
                        <div class="phone-info">
                            <p><strong>Passageiro:</strong> <span id="passengerContactName">N√£o informado</span></p>
                            <p class="phone-number"><i class="fas fa-phone"></i> <span id="passengerPhoneNumber">N√£o informado</span></p>
                            <p><small>Clique no bot√£o abaixo para conversar no WhatsApp</small></p>
                        </div>
                        <div class="communication-actions">
                            <a id="whatsappDriverBtn" class="whatsapp-btn" target="_blank">
                                <i class="fab fa-whatsapp"></i> Falar no WhatsApp
                            </a>
                            <a id="callDriverBtn" class="call-btn">
                                <i class="fas fa-phone"></i> Ligar
                            </a>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn-action" id="startRideBtn" style="background-color: #0a5c36;">
                            <i class="fas fa-play"></i> Iniciar Corrida
                        </button>
                        <button class="btn-action" id="completeRideBtn" style="background-color: #0a5c36; display: none;">
                            <i class="fas fa-flag-checkered"></i> Finalizar Corrida
                        </button>
                        <button class="btn-action" id="cancelActiveRideBtn" style="background-color: #dc3545; margin-top: 10px;">
                            <i class="fas fa-times"></i> Cancelar Corrida
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Profile Tab Content -->
        <div id="profileTab" class="tab-content">
            <div class="profile-section">
                <div class="profile-header">
                    <h2><i class="fas fa-user-edit"></i> Meu Perfil</h2>
                    <button class="close-profile" id="closeProfileBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="profileStatusMessage" class="status-message"></div>
                
                <form id="profileForm" class="profile-form">
                    <div class="form-group">
                        <label for="profileName">Nome Completo *</label>
                        <input type="text" id="profileName" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="profileEmail">E-mail</label>
                        <input type="email" id="profileEmail" class="form-control" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="profilePhone">Telefone *</label>
                        <input type="tel" id="profilePhone" class="form-control" placeholder="(11) 99999-9999" required>
                    </div>
                    
                    <!-- Campo espec√≠fico para piloto -->
                    <div class="form-group" id="profileVehicleField" style="display: none;">
                        <label for="profileVehicle">Placa da Moto</label>
                        <input type="text" id="profileVehicle" class="form-control" placeholder="ABC-1234">
                    </div>
                    
                    <!-- Se√ß√£o para altera√ß√£o de senha -->
                    <div class="password-section">
                        <h4><i class="fas fa-key"></i> Alterar Senha (opcional)</h4>
                        <div class="form-group">
                            <label for="currentPassword">Senha Atual</label>
                            <input type="password" id="currentPassword" class="form-control" placeholder="Digite apenas se quiser alterar">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Nova Senha</label>
                            <input type="password" id="newPassword" class="form-control" placeholder="M√≠nimo 6 caracteres" minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirmar Nova Senha</label>
                            <input type="password" id="confirmPassword" class="form-control" placeholder="Repita a nova senha" minlength="6">
                        </div>
                    </div>
                    
                    <div class="form-buttons">
                        <button type="submit" class="btn-action" id="profileSubmit">
                            <i class="fas fa-save"></i> Salvar Altera√ß√µes
                        </button>
                        <button type="button" class="cancel-btn" id="cancelProfileBtn">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- History Tab Content -->
        <div id="historyTab" class="tab-content">
            <div id="passengerHistory" class="info-box" style="display: none;">
                <h3><i class="fas fa-history"></i> Hist√≥rico de Corridas</h3>
                <p id="noHistoryMessage">Voc√™ ainda n√£o realizou nenhuma corrida.</p>
                <div id="historyList" style="display: none;"></div>
            </div>
            
            <div id="driverHistory" class="info-box" style="display: none;">
                <h3><i class="fas fa-history"></i> Hist√≥rico de Corridas</h3>
                <p id="driverNoHistoryMessage">Voc√™ ainda n√£o realizou nenhuma corrida.</p>
                <div id="driverHistoryList" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- PWA Install Button -->
    <button id="pwaInstallBtn" class="pwa-install-btn" title="Instalar App">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Test Notification Button (for debugging) -->
    <button id="testNotificationBtn" class="test-notification-btn" title="Testar Notifica√ß√£o">
        <i class="fas fa-bell"></i>
    </button>

    <!-- Audio element for notification sound -->
    <audio id="notificationSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAQ5TIcslVidUaALCdoDb7G8j7rolAfT8w",
            authDomain: "moto-c3a72.firebaseapp.com",
            databaseURL: "https://moto-c3a72-default-rtdb.firebaseio.com",
            projectId: "moto-c3a72",
            storageBucket: "moto-c3a72.firebasestorage.app",
            messagingSenderId: "721172312364",
            appId: "1:721172312364:web:7c4078a036d47add743c89",
            measurementId: "G-DSHQPKN8HK"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const messaging = firebase.messaging();

        // Global Variables
        let isLoginMode = true;
        let userRole = '';
        let currentUser = null;
        let currentRideId = null;
        let rideRequestsListener = null;
        let passengerRideListener = null;
        let driverActiveRideListener = null;
        let notificationCount = 0;
        let deferredPrompt = null;
        let isAppInstalled = false;
        let fcmToken = null;
        let serviceWorkerRegistration = null;
        let currentTab = 'dashboard';

        // DOM Elements
        const mainScreen = document.getElementById('mainScreen');
        const dashboardScreen = document.getElementById('dashboardScreen');
        const authModal = document.getElementById('authModal');
        const passengerBtn = document.getElementById('passengerBtn');
        const driverBtn = document.getElementById('driverBtn');
        const closeModal = document.getElementById('closeModal');
        const modalTitle = document.getElementById('modalTitle');
        const authForm = document.getElementById('authForm');
        const authSubmit = document.getElementById('authSubmit');
        const toggleAuthMode = document.getElementById('toggleAuthMode');
        const nameField = document.getElementById('nameField');
        const phoneField = document.getElementById('phoneField');
        const vehicleField = document.getElementById('vehicleField');
        const statusMessage = document.getElementById('statusMessage');
        const logoutBtn = document.getElementById('logoutBtn');
        const profileBtn = document.getElementById('profileBtn');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const userRoleElement = document.getElementById('userRole');
        const userProfileBtn = document.getElementById('userProfileBtn');
        const passengerDashboard = document.getElementById('passengerDashboard');
        const driverDashboard = document.getElementById('driverDashboard');
        const mobileNotifications = document.getElementById('mobileNotifications');
        const notificationBadge = document.getElementById('notificationBadge');
        const notificationBell = document.getElementById('notificationBell');
        const installBanner = document.getElementById('installBanner');
        const installBtn = document.getElementById('installBtn');
        const pwaInstallBtn = document.getElementById('pwaInstallBtn');
        const testNotificationBtn = document.getElementById('testNotificationBtn');
        const notificationAudio = document.getElementById('notificationSound');
        
        // Tab elements
        const tabBtns = document.querySelectorAll('.tab-btn');
        const dashboardTab = document.getElementById('dashboardTab');
        const profileTab = document.getElementById('profileTab');
        const historyTab = document.getElementById('historyTab');
        
        // Profile elements
        const profileForm = document.getElementById('profileForm');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const profilePhone = document.getElementById('profilePhone');
        const profileVehicleField = document.getElementById('profileVehicleField');
        const profileVehicle = document.getElementById('profileVehicle');
        const profileStatusMessage = document.getElementById('profileStatusMessage');
        const currentPassword = document.getElementById('currentPassword');
        const newPassword = document.getElementById('newPassword');
        const confirmPassword = document.getElementById('confirmPassword');
        const closeProfileBtn = document.getElementById('closeProfileBtn');
        const cancelProfileBtn = document.getElementById('cancelProfileBtn');
        
        // WhatsApp elements
        const whatsappSection = document.getElementById('whatsappSection');
        const driverContactName = document.getElementById('driverContactName');
        const driverPhoneNumber = document.getElementById('driverPhoneNumber');
        const whatsappPassengerBtn = document.getElementById('whatsappPassengerBtn');
        const callPassengerBtn = document.getElementById('callPassengerBtn');
        
        const whatsappDriverSection = document.getElementById('whatsappDriverSection');
        const passengerContactName = document.getElementById('passengerContactName');
        const passengerPhoneNumber = document.getElementById('passengerPhoneNumber');
        const whatsappDriverBtn = document.getElementById('whatsappDriverBtn');
        const callDriverBtn = document.getElementById('callDriverBtn');
        
        // Create Manifest dynamically
        const manifest = {
            "name": "MotoZap",
            "short_name": "MotoZap",
            "description": "Sua corrida r√°pida no interior",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#FF6600",
            "theme_color": "#FF6600",
            "icons": [
                {
                    "src": "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèçÔ∏è</text></svg>",
                    "sizes": "72x72 96x96 128x128 144x144 152x152 192x192 384x384 512x512",
                    "type": "image/svg+xml"
                }
            ]
        };
        
        // Set manifest
        document.getElementById('manifest').setAttribute('href', 'data:application/manifest+json,' + encodeURIComponent(JSON.stringify(manifest)));
        
        // Event Listeners
        passengerBtn.addEventListener('click', () => openAuthModal('passenger'));
        driverBtn.addEventListener('click', () => openAuthModal('driver'));
        closeModal.addEventListener('click', closeAuthModal);
        toggleAuthMode.addEventListener('click', toggleAuthFormMode);
        authForm.addEventListener('submit', handleAuthSubmit);
        logoutBtn.addEventListener('click', handleLogout);
        profileBtn.addEventListener('click', () => switchTab('profile'));
        installBtn.addEventListener('click', installPWA);
        pwaInstallBtn.addEventListener('click', installPWA);
        testNotificationBtn.addEventListener('click', testNotification);
        
        // Tab navigation
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });
        
        // Profile events
        userProfileBtn.addEventListener('click', () => switchTab('profile'));
        closeProfileBtn.addEventListener('click', () => switchTab('dashboard'));
        cancelProfileBtn.addEventListener('click', () => switchTab('dashboard'));
        profileForm.addEventListener('submit', handleProfileUpdate);
        
        // WhatsApp button click handlers
        whatsappPassengerBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const phone = driverPhoneNumber.textContent.replace(/\D/g, '');
            const name = driverContactName.textContent;
            if (phone && phone !== 'N√£oinformado') {
                openWhatsApp(phone, name, 'passageiro');
            }
        });
        
        callPassengerBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const phone = driverPhoneNumber.textContent.replace(/\D/g, '');
            if (phone && phone !== 'N√£oinformado') {
                window.location.href = `tel:${phone}`;
            }
        });
        
        whatsappDriverBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const phone = passengerPhoneNumber.textContent.replace(/\D/g, '');
            const name = passengerContactName.textContent;
            if (phone && phone !== 'N√£oinformado') {
                openWhatsApp(phone, name, 'piloto');
            }
        });
        
        callDriverBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const phone = passengerPhoneNumber.textContent.replace(/\D/g, '');
            if (phone && phone !== 'N√£oinformado') {
                window.location.href = `tel:${phone}`;
            }
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if app is already installed
            checkIfAppInstalled();
            
            // Listen for beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallPromotion();
            });
            
            // Check if app is running in standalone mode
            if (window.matchMedia('(display-mode: standalone)').matches) {
                isAppInstalled = true;
                hideInstallPromotion();
            }
            
            // Register Service Worker
            await registerServiceWorker();
            
            // Check if user is already logged in
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserData(user.uid);
                    
                    // Initialize Firebase Messaging after login
                    if (currentUser && Notification.permission === 'granted') {
                        await initializeFirebaseMessaging();
                    }
                } else {
                    showMainScreen();
                }
            });
            
            // Request notification permission
            await requestNotificationPermission();
            
            // Test if notification sound works
            setTimeout(() => {
                if (notificationAudio) {
                    notificationAudio.volume = 0.5;
                }
            }, 1000);
            
            // Phone formatting
            profilePhone.addEventListener('input', formatPhoneInput);
            document.getElementById('phone')?.addEventListener('input', formatPhoneInput);
            
            // Fechar modais com tecla ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (authModal.style.display === 'flex') {
                        closeAuthModal();
                    }
                }
            });
        });

        // ========== FUN√á√ïES DE NAVEGA√á√ÉO ==========

        // Tab switching function
        function switchTab(tabName) {
            // Update tab buttons
            tabBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            
            // Update tab contents
            dashboardTab.classList.toggle('active', tabName === 'dashboard');
            profileTab.classList.toggle('active', tabName === 'profile');
            historyTab.classList.toggle('active', tabName === 'history');
            
            currentTab = tabName;
            
            // If switching to profile tab, load current user data
            if (tabName === 'profile' && currentUser) {
                loadProfileData();
            }
            
            // If switching to history tab, load history
            if (tabName === 'history' && currentUser) {
                if (currentUser.role === 'passenger') {
                    loadPassengerHistory(currentUser.uid);
                } else {
                    loadDriverHistory(currentUser.uid);
                }
            }
        }

        // ========== FUN√á√ïES DE WHATSAPP ==========

        // Function to open WhatsApp
        function openWhatsApp(phone, name, role) {
            // Format phone number (remove non-digits and add country code if needed)
            let formattedPhone = phone.replace(/\D/g, '');
            
            // Add Brazil country code if not present
            if (!formattedPhone.startsWith('55') && formattedPhone.length <= 11) {
                formattedPhone = '55' + formattedPhone;
            }
            
            // Create message based on role
            let message = '';
            if (role === 'passageiro') {
                message = `Ol√° ${name}! Sou seu passageiro do MotoZap. Podemos combinar os detalhes da corrida?`;
            } else {
                message = `Ol√° ${name}! Sou seu piloto do MotoZap. Estou a caminho para busc√°-lo.`;
            }
            
            // Encode message for URL
            const encodedMessage = encodeURIComponent(message);
            
            // Create WhatsApp URL
            const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
            
            // Open WhatsApp
            window.open(whatsappUrl, '_blank');
        }

        // ========== FUN√á√ïES DE PWA ==========

        // Check if app is installed
        function checkIfAppInstalled() {
            if (window.matchMedia('(display-mode: standalone)').matches ||
                window.navigator.standalone ||
                document.referrer.includes('android-app://')) {
                isAppInstalled = true;
                hideInstallPromotion();
            }
        }

        // Show install promotion
        function showInstallPromotion() {
            if (!isAppInstalled && deferredPrompt) {
                installBanner.classList.remove('hidden');
                pwaInstallBtn.style.display = 'flex';
            }
        }

        // Hide install promotion
        function hideInstallPromotion() {
            installBanner.classList.add('hidden');
            pwaInstallBtn.style.display = 'none';
        }

        // Install PWA
        async function installPWA() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('App installed successfully');
                isAppInstalled = true;
                hideInstallPromotion();
                showMobileNotification({
                    title: 'App instalado!',
                    message: 'MotoZap foi instalado com sucesso!',
                    type: 'success'
                });
            }
            
            deferredPrompt = null;
        }

        // ========== FUN√á√ïES DE NOTIFICA√á√ïES ==========

        // Test notification function
        function testNotification() {
            showMobileNotification({
                title: 'Teste de Notifica√ß√£o',
                message: 'Esta √© uma notifica√ß√£o de teste do MotoZap!',
                type: 'new-ride',
                actions: [
                    {
                        text: 'Ver',
                        type: 'view'
                    }
                ]
            });
        }

        // Request notification permission
        async function requestNotificationPermission() {
            if ("Notification" in window && Notification.permission === "default") {
                try {
                    const permission = await Notification.requestPermission();
                    console.log("Permiss√£o de notifica√ß√£o:", permission);
                    
                    if (permission === 'granted' && currentUser) {
                        await initializeFirebaseMessaging();
                    }
                    
                    return permission;
                } catch (error) {
                    console.error("Erro ao solicitar permiss√£o:", error);
                    return 'denied';
                }
            }
            return Notification.permission;
        }

        // Register Service Worker
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    // Registrar o service worker inline
                    const serviceWorkerContent = `
self.addEventListener('install', event => {
    console.log('Service Worker instalado');
    self.skipWaiting();
});

self.addEventListener('activate', event => {
    console.log('Service Worker ativado');
    event.waitUntil(clients.claim());
});

self.addEventListener('push', event => {
    console.log('Push event received:', event);
    
    let data = {};
    if (event.data) {
        try {
            data = event.data.json();
        } catch (e) {
            console.log('Erro ao parsear dados:', e);
            data = {
                notification: {
                    title: 'MotoZap',
                    body: event.data.text() || 'Nova notifica√ß√£o'
                }
            };
        }
    }
    
    const options = {
        body: data.notification?.body || data.body || 'Nova notifica√ß√£o do MotoZap',
        icon: 'https://cdn-icons-png.flaticon.com/512/2965/2965358.png',
        badge: 'https://cdn-icons-png.flaticon.com/512/2965/2965358.png',
        tag: 'motozap-push',
        data: data.data || data,
        requireInteraction: true,
        actions: []
    };
    
    // Adicionar a√ß√µes baseadas no tipo
    if (data.data?.type === 'new-ride') {
        options.actions = [
            {
                action: 'accept',
                title: '‚úÖ Aceitar',
                icon: 'https://cdn-icons-png.flaticon.com/512/190/190411.png'
            },
            {
                action: 'decline',
                title: '‚ùå Recusar',
                icon: 'https://cdn-icons-png.flaticon.com/512/1828/1828843.png'
            }
        ];
    } else if (data.data?.type === 'ride-accepted') {
        options.actions = [
            {
                action: 'whatsapp',
                title: 'üí¨ WhatsApp',
                icon: 'https://cdn-icons-png.flaticon.com/512/220/220236.png'
            }
        ];
    }
    
    event.waitUntil(
        self.registration.showNotification(data.notification?.title || data.title || 'MotoZap', options)
    );
});

self.addEventListener('notificationclick', event => {
    console.log('Notification click:', event);
    
    event.notification.close();
    
    const notificationData = event.notification.data || {};
    
    event.waitUntil(
        clients.matchAll({type: 'window', includeUncontrolled: true})
        .then(clientList => {
            // Verificar se j√° tem uma janela aberta
            for (const client of clientList) {
                if (client.url.includes('/') && 'focus' in client) {
                    return client.focus().then(() => {
                        if (client.postMessage) {
                            client.postMessage({
                                type: 'NOTIFICATION_CLICK',
                                data: notificationData,
                                action: event.action
                            });
                        }
                    });
                }
            }
            
            // Se n√£o houver janela aberta, abrir uma nova
            if (clients.openWindow) {
                return clients.openWindow('/');
            }
        })
    );
});

self.addEventListener('message', event => {
    console.log('Service Worker message:', event.data);
});
                    `;
                    
                    const blob = new Blob([serviceWorkerContent], {type: 'application/javascript'});
                    const url = URL.createObjectURL(blob);
                    serviceWorkerRegistration = await navigator.serviceWorker.register(url);
                    console.log('Service Worker registrado:', serviceWorkerRegistration);
                    
                    // Escutar mensagens do Service Worker
                    navigator.serviceWorker.addEventListener('message', event => {
                        console.log('Mensagem do Service Worker:', event.data);
                        handleServiceWorkerMessage(event.data);
                    });
                    
                    return serviceWorkerRegistration;
                    
                } catch (error) {
                    console.error('Falha ao registrar Service Worker:', error);
                    return null;
                }
            } else {
                console.log('Service Worker n√£o suportado pelo navegador');
                return null;
            }
        }

        // Initialize Firebase Messaging
      async function initializeFirebaseMessaging() {
    try {
        // Solicitar permiss√£o para notifica√ß√µes
        const permission = await Notification.requestPermission();
        
        if (permission === 'granted') {
            console.log('Permiss√£o de notifica√ß√£o concedida');
            
            // Registrar Service Worker primeiro
            if ('serviceWorker' in navigator) {
                // Obter registro do Service Worker
                const registration = await navigator.serviceWorker.ready;
                
                console.log('Service Worker registrado, usando:', registration);
                
                // Usar a VAPID key p√∫blica
                const vapidKey = 'BE6r0LR0z1pSzQRnNRV0TGbQ7QOY9epBAPJgLj0v2lS3JYVg3nSFhU1gyV_x3T1bZakO0pN_rB4Lw8YdWx1Sq_o';
                
                // Obter token FCM
                try {
                    fcmToken = await messaging.getToken({
                        serviceWorkerRegistration: registration,
                        vapidKey: vapidKey
                    });
                    
                    if (fcmToken) {
                        console.log('Token FCM obtido:', fcmToken);
                        messagingInitialized = true;
                        
                        // Salvar token no banco de dados
                        if (currentUser) {
                            await saveFCMTokenToDatabase(fcmToken);
                        }
                        
                        // Enviar token para o Service Worker
                        if (registration.active) {
                            registration.active.postMessage({
                                type: 'FCM_TOKEN',
                                token: fcmToken
                            });
                        }
                    } else {
                        console.log('N√£o foi poss√≠vel obter token FCM');
                    }
                } catch (tokenError) {
                    console.error('Erro ao obter token FCM:', tokenError);
                }
                
                // Configurar handler para mensagens em primeiro plano
                messaging.onMessage((payload) => {
                    console.log('Mensagem recebida em primeiro plano:', payload);
                    
                    // Mostrar notifica√ß√£o no app
                    if (payload.notification) {
                        showMobileNotification({
                            title: payload.notification.title,
                            message: payload.notification.body,
                            type: payload.data?.type || 'info',
                            data: payload.data
                        });
                    }
                });
                
                // Configurar handler para atualiza√ß√£o do token
                messaging.onTokenRefresh(async () => {
                    console.log('Token FCM atualizado');
                    const newToken = await messaging.getToken({
                        serviceWorkerRegistration: registration,
                        vapidKey: vapidKey
                    });
                    fcmToken = newToken;
                    
                    if (currentUser) {
                        await saveFCMTokenToDatabase(newToken);
                    }
                });
            }
        } else {
            console.log('Permiss√£o de notifica√ß√£o negada:', permission);
        }
    } catch (error) {
        console.error('Erro ao inicializar Firebase Messaging:', error);
    }
}

        // Save FCM token to database
        async function saveFCMTokenToDatabase(token) {
            try {
                if (!currentUser || !token) return;
                
                const userRef = database.ref('users/' + currentUser.uid);
                await userRef.update({
                    fcmToken: token,
                    fcmTokenUpdatedAt: new Date().toISOString()
                });
                
                console.log('Token FCM salvo no banco de dados');
            } catch (error) {
                console.error('Erro ao salvar token FCM:', error);
            }
        }

        // Send push notification
        async function sendPushNotification(toUserId, notificationData) {
            try {
                // Obter token FCM do destinat√°rio
                const userSnapshot = await database.ref('users/' + toUserId).once('value');
                const userData = userSnapshot.val();
                
                if (!userData || !userData.fcmToken) {
                    console.log('Usu√°rio n√£o tem token FCM registrado');
                    return false;
                }
                
                // Simular envio de notifica√ß√£o push
                // Em produ√ß√£o, voc√™ precisaria de um backend para enviar notifica√ß√µes FCM
                console.log('Simulando envio de push para:', userData.fcmToken);
                console.log('Dados:', notificationData);
                
                // Mostrar notifica√ß√£o local para teste
                if (toUserId === currentUser?.uid) {
                    showMobileNotification({
                        title: notificationData.title,
                        message: notificationData.body,
                        type: notificationData.data?.type || 'info',
                        data: notificationData.data
                    });
                }
                
                return true;
            } catch (error) {
                console.error('Erro ao enviar notifica√ß√£o push:', error);
                return false;
            }
        }

        // Show mobile notification
        function showMobileNotification(data) {
            const notificationId = 'notification-' + Date.now();
            const notification = document.createElement('div');
            notification.className = `mobile-notification ${data.type || ''}`;
            notification.id = notificationId;
            
            const time = new Date().toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            let actionsHTML = '';
            if (data.actions && data.actions.length > 0) {
                actionsHTML = '<div class="notification-actions">';
                data.actions.forEach(action => {
                    if (action.type === 'whatsapp') {
                        actionsHTML += `
                            <button class="notification-btn whatsapp" onclick="handleNotificationAction('${notificationId}', '${action.type}', '${action.phone || ''}', '${action.name || ''}', '${action.role || ''}')">
                                <i class="fab fa-whatsapp"></i> ${action.text}
                            </button>
                        `;
                    } else if (action.type === 'accept' || action.type === 'decline') {
                        actionsHTML += `
                            <button class="notification-btn ${action.type}" onclick="handleNotificationAction('${notificationId}', '${action.type}', '${action.rideId || ''}')">
                                ${action.text}
                            </button>
                        `;
                    } else {
                        actionsHTML += `
                            <button class="notification-btn ${action.type}" onclick="handleNotificationAction('${notificationId}', '${action.type}')">
                                ${action.text}
                            </button>
                        `;
                    }
                });
                actionsHTML += '</div>';
            }
            
            notification.innerHTML = `
                <button class="notification-close" onclick="removeNotification('${notificationId}')">&times;</button>
                <div class="notification-header">
                    <div class="notification-title">
                        <i class="fas fa-bell"></i> ${data.title}
                    </div>
                    <div class="notification-time">${time}</div>
                </div>
                <div class="notification-body">${data.message}</div>
                ${actionsHTML}
            `;
            
            mobileNotifications.appendChild(notification);
            
            // Play notification sound
            if (notificationAudio) {
                notificationAudio.currentTime = 0;
                notificationAudio.play().catch(e => console.log("Erro ao tocar som:", e));
            }
            
            // Vibrate if supported
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
            
            // Update badge count
            if (data.type === 'new-ride') {
                notificationCount++;
                updateNotificationBadge();
            }
            
            // Auto-remove notification after 30 seconds
            setTimeout(() => {
                removeNotification(notificationId);
            }, 30000);
            
            return notificationId;
        }

        // Remove notification
        function removeNotification(id) {
            const notification = document.getElementById(id);
            if (notification) {
                notification.classList.add('hiding');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }

        // Handle notification action
        window.handleNotificationAction = function(notificationId, actionType, param1, param2, param3) {
            removeNotification(notificationId);
            
            switch(actionType) {
                case 'accept':
                    // Aceitar corrida
                    if (param1) {
                        acceptRideFromNotification(param1);
                    }
                    break;
                case 'decline':
                    // Recusar corrida
                    if (param1) {
                        declineRideFromNotification(param1);
                    }
                    break;
                case 'whatsapp':
                    // Open WhatsApp
                    if (param1 && param2 && param3) {
                        openWhatsApp(param1, param2, param3);
                    }
                    break;
                case 'view':
                    // Switch to dashboard tab
                    switchTab('dashboard');
                    break;
            }
        }

        // Handle service worker message
        function handleServiceWorkerMessage(message) {
            console.log('Mensagem do Service Worker recebida:', message);
            
            if (message.type === 'NOTIFICATION_CLICK') {
                // Lidar com clique na notifica√ß√£o
                handleNotificationClick(message.data, message.action);
            }
        }

        // Handle notification click
        function handleNotificationClick(notificationData, action) {
            console.log('Notifica√ß√£o clicada:', notificationData, 'A√ß√£o:', action);
            
            // Se o app estava em background, trazer para frente
            if (document.hidden) {
                window.focus();
            }
            
            // Processar a√ß√£o da notifica√ß√£o
            switch(action) {
                case 'accept':
                    // Aceitar corrida
                    if (notificationData.rideId) {
                        acceptRideFromNotification(notificationData.rideId);
                    }
                    break;
                case 'decline':
                    // Recusar corrida
                    if (notificationData.rideId) {
                        declineRideFromNotification(notificationData.rideId);
                    }
                    break;
                case 'whatsapp':
                    // Abrir WhatsApp
                    if (notificationData.phone && notificationData.name) {
                        openWhatsApp(notificationData.phone, notificationData.name, 
                                    notificationData.role || 'passageiro');
                    }
                    break;
                default:
                    // Navegar para a aba relevante
                    if (notificationData.type === 'new-ride') {
                        switchTab('dashboard');
                    } else if (notificationData.type === 'ride-accepted') {
                        switchTab('dashboard');
                    }
                    break;
            }
        }

        // Accept ride from notification
        async function acceptRideFromNotification(rideId) {
            if (!currentUser || currentUser.role !== 'driver') {
                showMobileNotification({
                    title: 'Erro',
                    message: 'Apenas motoristas podem aceitar corridas.',
                    type: 'error'
                });
                return;
            }
            
            try {
                const rideSnapshot = await database.ref('rides/' + rideId).once('value');
                const ride = rideSnapshot.val();
                
                if (!ride) {
                    showMobileNotification({
                        title: 'Erro',
                        message: 'Corrida n√£o encontrada.',
                        type: 'error'
                    });
                    return;
                }
                
                await database.ref('rides/' + rideId).update({
                    status: 'accepted',
                    driverId: currentUser.uid,
                    driverName: currentUser.name,
                    driverPhone: currentUser.phone,
                    acceptedAt: new Date().toISOString()
                });
                
                await database.ref('drivers/' + currentUser.uid).update({
                    available: false,
                    lastUpdate: new Date().toISOString()
                });
                
                // Mostrar notifica√ß√£o no app
                showMobileNotification({
                    title: 'Corrida Aceita!',
                    message: `Voc√™ aceitou a corrida de ${ride.passengerName}`,
                    type: 'success'
                });
                
                // Enviar notifica√ß√£o para o passageiro
                await sendPushNotification(ride.passengerId, {
                    title: 'Corrida Aceita!',
                    body: `Piloto ${currentUser.name} aceitou sua corrida. Telefone: ${currentUser.phone}`,
                    data: {
                        type: 'ride-accepted',
                        driverName: currentUser.name,
                        driverPhone: currentUser.phone,
                        role: 'passageiro'
                    }
                });
                
            } catch (error) {
                console.error('Erro ao aceitar corrida da notifica√ß√£o:', error);
                showMobileNotification({
                    title: 'Erro',
                    message: 'Erro ao aceitar corrida.',
                    type: 'error'
                });
            }
        }

        // Decline ride from notification
        async function declineRideFromNotification(rideId) {
            try {
                await database.ref('rides/' + rideId).update({
                    status: 'cancelled',
                    cancelledAt: new Date().toISOString(),
                    cancelledBy: 'driver'
                });
                
                showMobileNotification({
                    title: 'Corrida Recusada',
                    message: 'Voc√™ recusou a corrida.',
                    type: 'info'
                });
                
            } catch (error) {
                console.error('Erro ao recusar corrida da notifica√ß√£o:', error);
                showMobileNotification({
                    title: 'Erro',
                    message: 'Erro ao recusar corrida.',
                    type: 'error'
                });
            }
        }

        // Update notification badge
        function updateNotificationBadge() {
            if (notificationCount > 0) {
                notificationBadge.textContent = notificationCount > 9 ? '9+' : notificationCount;
                notificationBadge.style.display = 'flex';
            } else {
                notificationBadge.style.display = 'none';
            }
        }

        // ========== FUN√á√ïES DE AUTENTICA√á√ÉO ==========

        function openAuthModal(role) {
            userRole = role;
            isLoginMode = true;
            updateAuthForm();
            authModal.style.display = 'flex';
        }

        function closeAuthModal() {
            authModal.style.display = 'none';
            resetAuthForm();
        }

        function toggleAuthFormMode(e) {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            updateAuthForm();
        }

        function updateAuthForm() {
            if (isLoginMode) {
                modalTitle.textContent = `Entrar como ${userRole === 'passenger' ? 'Passageiro' : 'Piloto'}`;
                authSubmit.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar';
                toggleAuthMode.textContent = 'N√£o tem uma conta? Cadastre-se';
                
                nameField.style.display = 'none';
                phoneField.style.display = 'none';
                vehicleField.style.display = 'none';
            } else {
                modalTitle.textContent = `Cadastrar como ${userRole === 'passenger' ? 'Passageiro' : 'Piloto'}`;
                authSubmit.innerHTML = '<i class="fas fa-user-plus"></i> Cadastrar';
                toggleAuthMode.textContent = 'J√° tem uma conta? Fa√ßa login';
                
                nameField.style.display = 'block';
                phoneField.style.display = 'block';
                vehicleField.style.display = userRole === 'driver' ? 'block' : 'none';
                
                if (userRole === 'driver') {
                    document.getElementById('vehicle').required = true;
                } else {
                    document.getElementById('vehicle').required = false;
                }
            }
            
            hideStatusMessage();
        }

        function resetAuthForm() {
            authForm.reset();
            hideStatusMessage();
        }

        function showStatusMessage(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
        }

        function hideStatusMessage() {
            statusMessage.style.display = 'none';
        }

        async function handleAuthSubmit(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showStatusMessage('Por favor, preencha todos os campos obrigat√≥rios.', 'error');
                return;
            }
            
            if (password.length < 6) {
                showStatusMessage('A senha deve ter pelo menos 6 caracteres.', 'error');
                return;
            }
            
            try {
                if (isLoginMode) {
                    showStatusMessage('Entrando...', 'info');
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    showStatusMessage('Login realizado com sucesso!', 'success');
                    
                    setTimeout(() => {
                        closeAuthModal();
                        loadUserData(userCredential.user.uid);
                    }, 1500);
                } else {
                    const name = document.getElementById('name')?.value.trim() || '';
                    const phone = document.getElementById('phone')?.value.trim() || '';
                    const vehicle = userRole === 'driver' ? document.getElementById('vehicle')?.value.trim() || '' : '';
                    
                    if (!name || !phone) {
                        showStatusMessage('Por favor, preencha todos os campos obrigat√≥rios.', 'error');
                        return;
                    }
                    
                    if (userRole === 'driver' && !vehicle) {
                        showStatusMessage('Por favor, informe a placa da moto.', 'error');
                        return;
                    }
                    
                    showStatusMessage('Criando conta...', 'info');
                    
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    const userData = {
                        name: name,
                        email: email,
                        phone: phone,
                        role: userRole,
                        createdAt: new Date().toISOString(),
                        uid: user.uid
                    };
                    
                    if (userRole === 'driver') {
                        userData.vehicle = vehicle;
                        userData.available = false;
                        userData.rating = 5.0;
                        userData.totalRides = 0;
                    }
                    
                    await database.ref('users/' + user.uid).set(userData);
                    
                    if (userRole === 'driver') {
                        await database.ref('drivers/' + user.uid).set({
                            name: name,
                            email: email,
                            phone: phone,
                            vehicle: vehicle,
                            available: false,
                            rating: 5.0,
                            totalRides: 0,
                            createdAt: new Date().toISOString()
                        });
                    } else {
                        await database.ref('passengers/' + user.uid).set({
                            name: name,
                            email: email,
                            phone: phone,
                            createdAt: new Date().toISOString()
                        });
                    }
                    
                    showStatusMessage('Conta criada com sucesso! Redirecionando...', 'success');
                    
                    setTimeout(() => {
                        closeAuthModal();
                        loadUserData(user.uid);
                    }, 1500);
                }
            } catch (error) {
                console.error('Authentication error:', error);
                let errorMessage = 'Ocorreu um erro. Tente novamente.';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Este e-mail j√° est√° em uso.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'E-mail inv√°lido.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Senha muito fraca. Use pelo menos 6 caracteres.';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = 'Usu√°rio n√£o encontrado.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Senha incorreta.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Erro de conex√£o. Verifique sua internet.';
                        break;
                }
                
                showStatusMessage(errorMessage, 'error');
            }
        }

        // ========== FUN√á√ïES DE USU√ÅRIO ==========

        async function loadUserData(userId) {
            try {
                const userSnapshot = await database.ref('users/' + userId).once('value');
                const userData = userSnapshot.val();
                
                if (userData) {
                    // Load additional data based on role
                    if (userData.role === 'driver') {
                        const driverSnapshot = await database.ref('drivers/' + userId).once('value');
                        const driverData = driverSnapshot.val();
                        if (driverData) {
                            Object.assign(userData, driverData);
                        }
                    } else {
                        const passengerSnapshot = await database.ref('passengers/' + userId).once('value');
                        const passengerData = passengerSnapshot.val();
                        if (passengerData) {
                            Object.assign(userData, passengerData);
                        }
                    }
                    
                    // Add auth email
                    userData.email = auth.currentUser.email;
                    
                    currentUser = { ...auth.currentUser, ...userData };
                    
                    console.log('Dados do usu√°rio carregados:', currentUser);
                    
                    // Update UI
                    userName.textContent = currentUser.name || 'Usu√°rio';
                    userRoleElement.textContent = currentUser.role === 'passenger' ? 'Passageiro' : 'Piloto';
                    userAvatar.textContent = (currentUser.name && currentUser.name.charAt(0).toUpperCase()) || 'U';
                    
                    // Set up specific dashboards
                    if (currentUser.role === 'passenger') {
                        passengerDashboard.style.display = 'block';
                        driverDashboard.style.display = 'none';
                        notificationBell.style.display = 'none';
                        document.getElementById('passengerHistory').style.display = 'block';
                        document.getElementById('driverHistory').style.display = 'none';
                        loadPassengerHistory(userId);
                        listenToPassengerRides(userId);
                    } else {
                        passengerDashboard.style.display = 'none';
                        driverDashboard.style.display = 'block';
                        notificationBell.style.display = 'block';
                        document.getElementById('passengerHistory').style.display = 'none';
                        document.getElementById('driverHistory').style.display = 'block';
                        setupDriverAvailability(userId);
                        loadDriverHistory(userId);
                        listenToRideRequests();
                        listenToDriverActiveRide(userId);
                        listenForNewRides();
                        
                        showMobileNotification({
                            title: 'Bem-vindo, Piloto!',
                            message: 'Voc√™ agora est√° online e receber√° notifica√ß√µes de novas corridas.',
                            type: 'success'
                        });
                    }
                    
                    showDashboard();
                    
                    // Initialize Firebase Messaging
                    if (Notification.permission === 'granted') {
                        await initializeFirebaseMessaging();
                    }
                } else {
                    await auth.signOut();
                    showMainScreen();
                    alert('Dados do usu√°rio n√£o encontrados. Por favor, fa√ßa login novamente.');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showMobileNotification({
                    title: 'Erro',
                    message: 'Erro ao carregar dados do usu√°rio.',
                    type: 'error'
                });
            }
        }

        function showMainScreen() {
            mainScreen.style.display = 'block';
            dashboardScreen.style.display = 'none';
            
            // Remove listeners
            if (rideRequestsListener) {
                rideRequestsListener();
                rideRequestsListener = null;
            }
            if (passengerRideListener) {
                passengerRideListener();
                passengerRideListener = null;
            }
            if (driverActiveRideListener) {
                driverActiveRideListener();
                driverActiveRideListener = null;
            }
        }

        function showDashboard() {
            mainScreen.style.display = 'none';
            dashboardScreen.style.display = 'block';
            switchTab('dashboard');
        }

        function handleLogout() {
            if (currentUser && currentUser.role === 'driver') {
                database.ref('drivers/' + currentUser.uid).update({
                    available: false,
                    lastUpdate: new Date().toISOString()
                });
            }
            
            auth.signOut().then(() => {
                currentUser = null;
                currentRideId = null;
                notificationCount = 0;
                updateNotificationBadge();
                showMainScreen();
            }).catch((error) => {
                console.error('Logout error:', error);
                showMobileNotification({
                    title: 'Erro',
                    message: 'Erro ao fazer logout.',
                    type: 'error'
                });
            });
        }

        // ========== FUN√á√ïES DE PERFIL ==========

        function loadProfileData() {
            if (!currentUser) return;
            
            profileName.value = currentUser.name || '';
            profileEmail.value = currentUser.email || '';
            profilePhone.value = currentUser.phone || '';
            
            if (currentUser.role === 'driver') {
                profileVehicleField.style.display = 'block';
                profileVehicle.value = currentUser.vehicle || '';
            } else {
                profileVehicleField.style.display = 'none';
            }
            
            // Clear password fields
            currentPassword.value = '';
            newPassword.value = '';
            confirmPassword.value = '';
            
            hideProfileStatusMessage();
        }

        function showProfileStatusMessage(message, type) {
            profileStatusMessage.textContent = message;
            profileStatusMessage.className = `status-message status-${type}`;
            profileStatusMessage.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    hideProfileStatusMessage();
                }, 5000);
            }
        }

        function hideProfileStatusMessage() {
            profileStatusMessage.style.display = 'none';
        }

        // Format phone input
        function formatPhoneInput(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length > 11) {
                value = value.substring(0, 11);
            }
            
            // Formatar enquanto digita
            if (value.length > 0) {
                if (value.length <= 2) {
                    value = `(${value}`;
                } else if (value.length <= 7) {
                    value = `(${value.substring(0,2)}) ${value.substring(2)}`;
                } else if (value.length <= 11) {
                    value = `(${value.substring(0,2)}) ${value.substring(2,7)}-${value.substring(7)}`;
                }
            }
            
            e.target.value = value;
        }

        function validatePhone(phone) {
            const phoneDigits = phone.replace(/\D/g, '');
            return phoneDigits.length >= 10 && phoneDigits.length <= 11;
        }

        function formatPhone(phone) {
            const phoneDigits = phone.replace(/\D/g, '');
            
            if (phoneDigits.length === 11) {
                return `(${phoneDigits.substring(0,2)}) ${phoneDigits.substring(2,7)}-${phoneDigits.substring(7)}`;
            } else if (phoneDigits.length === 10) {
                return `(${phoneDigits.substring(0,2)}) ${phoneDigits.substring(2,6)}-${phoneDigits.substring(6)}`;
            }
            
            return phone;
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            
            // Validate required fields
            if (!profileName.value.trim()) {
                showProfileStatusMessage('Por favor, informe seu nome completo.', 'error');
                return;
            }
            
            if (!profilePhone.value.trim()) {
                showProfileStatusMessage('Por favor, informe seu telefone.', 'error');
                return;
            }
            
            // Validate phone
            if (!validatePhone(profilePhone.value)) {
                showProfileStatusMessage('Por favor, informe um telefone v√°lido com DDD (10 ou 11 d√≠gitos).', 'error');
                return;
            }
            
            // Validate vehicle plate for drivers
            if (currentUser.role === 'driver' && profileVehicle.value.trim()) {
                const plateRegex = /^[A-Z]{3}-\d{4}$|^[A-Z]{3}\d{4}$/i;
                if (!plateRegex.test(profileVehicle.value.trim())) {
                    showProfileStatusMessage('Formato de placa inv√°lido. Use formato ABC-1234 ou ABC1234.', 'error');
                    return;
                }
            }
            
            // Validate password change
            if (newPassword.value || confirmPassword.value) {
                if (!currentPassword.value) {
                    showProfileStatusMessage('Para alterar a senha, informe a senha atual.', 'error');
                    return;
                }
                
                if (newPassword.value.length < 6) {
                    showProfileStatusMessage('A nova senha deve ter pelo menos 6 caracteres.', 'error');
                    return;
                }
                
                if (newPassword.value !== confirmPassword.value) {
                    showProfileStatusMessage('As novas senhas n√£o coincidem.', 'error');
                    return;
                }
            }
            
            try {
                showProfileStatusMessage('Atualizando perfil...', 'info');
                
                // Format phone number
                const formattedPhone = formatPhone(profilePhone.value.trim());
                
                // Prepare update data
                const updates = {
                    name: profileName.value.trim(),
                    phone: formattedPhone,
                    updatedAt: new Date().toISOString()
                };
                
                // Add vehicle for drivers
                if (currentUser.role === 'driver') {
                    updates.vehicle = profileVehicle.value.trim().toUpperCase();
                }
                
                console.log('Atualizando perfil com dados:', updates);
                
                // Update in Firebase Realtime Database
                await database.ref('users/' + currentUser.uid).update(updates);
                
                // Update in specific collection (passengers or drivers)
                if (currentUser.role === 'passenger') {
                    await database.ref('passengers/' + currentUser.uid).update(updates);
                } else {
                    await database.ref('drivers/' + currentUser.uid).update(updates);
                    
                    // Update in active rides if any
                    if (currentRideId) {
                        await database.ref('rides/' + currentRideId).update({
                            driverName: updates.name,
                            driverPhone: updates.phone
                        });
                    }
                }
                
                // Update local currentUser object
                Object.assign(currentUser, updates);
                
                // Update UI
                userName.textContent = updates.name;
                userAvatar.textContent = updates.name.charAt(0).toUpperCase();
                
                // Update password if provided
                if (newPassword.value && newPassword.value.length >= 6) {
                    console.log('Tentando atualizar senha...');
                    
                    try {
                        const credential = firebase.auth.EmailAuthProvider.credential(
                            currentUser.email,
                            currentPassword.value
                        );
                        
                        await auth.currentUser.reauthenticateWithCredential(credential);
                        console.log('Reautentica√ß√£o bem-sucedida');
                        
                        await auth.currentUser.updatePassword(newPassword.value);
                        console.log('Senha atualizada com sucesso');
                        
                        // Clear password fields
                        currentPassword.value = '';
                        newPassword.value = '';
                        confirmPassword.value = '';
                        
                    } catch (authError) {
                        console.error('Erro na autentica√ß√£o para alterar senha:', authError);
                        if (authError.code === 'auth/wrong-password') {
                            showProfileStatusMessage('Senha atual incorreta. A senha n√£o foi alterada, mas os outros dados foram atualizados.', 'error');
                            return;
                        }
                        throw authError;
                    }
                }
                
                showProfileStatusMessage('Perfil atualizado com sucesso!', 'success');
                
                // Show mobile notification
                showMobileNotification({
                    title: 'Perfil Atualizado!',
                    message: 'Seus dados foram atualizados com sucesso.',
                    type: 'success'
                });
                
                // Switch back to dashboard after 2 seconds
                setTimeout(() => {
                    switchTab('dashboard');
                }, 2000);
                
            } catch (error) {
                console.error('Erro completo ao atualizar perfil:', error);
                let errorMessage = 'Ocorreu um erro ao atualizar o perfil. Tente novamente.';
                
                switch (error.code) {
                    case 'auth/wrong-password':
                        errorMessage = 'Senha atual incorreta. A senha n√£o foi alterada.';
                        break;
                    case 'auth/requires-recent-login':
                        errorMessage = 'Por favor, fa√ßa login novamente para alterar a senha.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'A nova senha √© muito fraca. Use pelo menos 6 caracteres.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Erro de conex√£o. Verifique sua internet e tente novamente.';
                        break;
                }
                
                showProfileStatusMessage(errorMessage, 'error');
                
                showMobileNotification({
                    title: 'Erro ao Atualizar',
                    message: errorMessage,
                    type: 'error'
                });
            }
        }

        // ========== FUN√á√ïES DE DRIVER ==========

        // Driver Availability Functions
        function setupDriverAvailability(userId) {
            const toggleAvailabilityBtn = document.getElementById('toggleAvailabilityBtn');
            const availabilityText = document.getElementById('availabilityText');
            const availabilityStatus = document.getElementById('availabilityStatus');
            
            database.ref('drivers/' + userId + '/available').once('value')
                .then(snapshot => {
                    const isAvailable = snapshot.val() || false;
                    updateDriverAvailabilityUI(isAvailable);
                });
            
            toggleAvailabilityBtn.addEventListener('click', () => {
                database.ref('drivers/' + userId + '/available').once('value')
                    .then(snapshot => {
                        const currentStatus = snapshot.val() || false;
                        const newStatus = !currentStatus;
                        
                        database.ref('drivers/' + userId).update({
                            available: newStatus,
                            lastUpdate: new Date().toISOString()
                        });
                        
                        updateDriverAvailabilityUI(newStatus);
                        
                        if (newStatus) {
                            showMobileNotification({
                                title: 'Dispon√≠vel',
                                message: 'Agora voc√™ est√° dispon√≠vel para receber corridas!',
                                type: 'success'
                            });
                        } else {
                            showMobileNotification({
                                title: 'Indispon√≠vel',
                                message: 'Voc√™ est√° indispon√≠vel para corridas.',
                                type: 'info'
                            });
                        }
                    });
            });
            
            function updateDriverAvailabilityUI(isAvailable) {
                if (isAvailable) {
                    availabilityText.textContent = 'Ficar Indispon√≠vel';
                    availabilityStatus.textContent = 'Status: Dispon√≠vel para corridas';
                    availabilityStatus.style.color = '#0a5c36';
                } else {
                    availabilityText.textContent = 'Ficar Dispon√≠vel';
                    availabilityStatus.textContent = 'Status: Indispon√≠vel';
                    availabilityStatus.style.color = '#dc3545';
                }
            }
        }

        // Listen to ride requests for drivers
        function listenToRideRequests() {
            const rideRequestsList = document.getElementById('rideRequestsList');
            const noRequestsMessage = document.getElementById('noRequestsMessage');
            
            if (rideRequestsListener) {
                rideRequestsListener();
            }
            
            rideRequestsListener = database.ref('rides')
                .orderByChild('status')
                .equalTo('pending')
                .on('value', (snapshot) => {
                    const rides = snapshot.val();
                    rideRequestsList.innerHTML = '';
                    
                    if (rides) {
                        noRequestsMessage.style.display = 'none';
                        
                        Object.keys(rides).forEach(rideId => {
                            const ride = rides[rideId];
                            
                            // Check if driver is available
                            database.ref('drivers/' + currentUser.uid + '/available').once('value')
                                .then(driverSnapshot => {
                                    const isAvailable = driverSnapshot.val();
                                    
                                    if (isAvailable) {
                                        const rideElement = createRideRequestElement(rideId, ride);
                                        rideRequestsList.appendChild(rideElement);
                                    }
                                });
                        });
                        
                        if (rideRequestsList.children.length === 0) {
                            noRequestsMessage.style.display = 'block';
                        }
                    } else {
                        noRequestsMessage.style.display = 'block';
                    }
                });
        }

        // Listen for new rides (for notifications)
        function listenForNewRides() {
            let lastRideId = null;
            
            database.ref('rides')
                .orderByChild('status')
                .equalTo('pending')
                .on('child_added', (snapshot) => {
                    const ride = snapshot.val();
                    const rideId = snapshot.key;
                    
                    // Only notify if this is a new ride and driver is available
                    if (rideId !== lastRideId) {
                        lastRideId = rideId;
                        
                        database.ref('drivers/' + currentUser.uid + '/available').once('value')
                            .then(driverSnapshot => {
                                const isAvailable = driverSnapshot.val();
                                
                                if (isAvailable && currentUser.uid !== ride.passengerId) {
                                    // Show mobile notification
                                    const notificationId = showMobileNotification({
                                        title: 'Nova Corrida Dispon√≠vel!',
                                        message: `${ride.passengerName} solicitou uma corrida de ${ride.pickup} para ${ride.destination} por R$ ${ride.price}`,
                                        type: 'new-ride',
                                        rideId: rideId,
                                        passengerName: ride.passengerName,
                                        passengerPhone: ride.passengerPhone,
                                        pickup: ride.pickup,
                                        destination: ride.destination,
                                        price: ride.price,
                                        actions: [
                                            {
                                                text: 'Aceitar',
                                                type: 'accept',
                                                rideId: rideId
                                            },
                                            {
                                                text: 'Recusar',
                                                type: 'decline',
                                                rideId: rideId
                                            },
                                            {
                                                text: 'Ver',
                                                type: 'view'
                                            }
                                        ]
                                    });
                                    
                                    // Store ride info with notification
                                    const notificationElement = document.getElementById(notificationId);
                                    if (notificationElement) {
                                        notificationElement.dataset.rideId = rideId;
                                    }
                                }
                            });
                    }
                });
        }

        function createRideRequestElement(rideId, ride) {
            const div = document.createElement('div');
            div.className = 'driver-card';
            div.innerHTML = `
                <h4 style="color: #FF6600; margin-bottom: 10px;">Nova Corrida Dispon√≠vel</h4>
                <p><strong>Passageiro:</strong> ${ride.passengerName}</p>
                <p><strong>De:</strong> ${ride.pickup}</p>
                <p><strong>Para:</strong> ${ride.destination}</p>
                <p><strong>Valor Sugerido:</strong> R$ ${ride.price}</p>
                <p><strong>Telefone:</strong> ${ride.passengerPhone || 'N√£o informado'}</p>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn-action accept-ride-btn" data-ride-id="${rideId}" style="background-color: #0a5c36;">
                        <i class="fas fa-check"></i> Aceitar
                    </button>
                    <button class="btn-action decline-ride-btn" data-ride-id="${rideId}" style="background-color: #dc3545;">
                        <i class="fas fa-times"></i> Recusar
                    </button>
                </div>
            `;
            
            return div;
        }

        // Listen to passenger rides
        function listenToPassengerRides(userId) {
            if (passengerRideListener) {
                passengerRideListener();
            }
            
            passengerRideListener = database.ref('rides')
                .orderByChild('passengerId')
                .equalTo(userId)
                .on('value', (snapshot) => {
                    const rides = snapshot.val();
                    
                    if (rides) {
                        // Find active ride (pending or accepted)
                        Object.keys(rides).forEach(rideId => {
                            const ride = rides[rideId];
                            if (ride.status === 'pending' || ride.status === 'accepted' || ride.status === 'started') {
                                currentRideId = rideId;
                                updatePassengerRideStatus(ride);
                            }
                        });
                    }
                });
        }

        // Listen to driver active ride
        function listenToDriverActiveRide(driverId) {
            if (driverActiveRideListener) {
                driverActiveRideListener();
            }
            
            driverActiveRideListener = database.ref('rides')
                .orderByChild('driverId')
                .equalTo(driverId)
                .on('value', (snapshot) => {
                    const rides = snapshot.val();
                    
                    if (rides) {
                        Object.keys(rides).forEach(rideId => {
                            const ride = rides[rideId];
                            if (ride.status === 'accepted' || ride.status === 'started') {
                                currentRideId = rideId;
                                showDriverActiveRide(ride);
                            }
                        });
                    }
                });
        }

        // Update passenger ride status with WhatsApp section
        function updatePassengerRideStatus(ride) {
            const rideStatus = document.getElementById('rideStatus');
            const rideStatusIcon = document.getElementById('rideStatusIcon');
            const rideStatusTitle = document.getElementById('rideStatusTitle');
            const rideDetails = document.getElementById('rideDetails');
            
            rideStatus.style.display = 'block';
            
            let statusText = '';
            let iconClass = 'fas fa-spinner fa-spin';
            let title = 'Status da Corrida';
            
            switch(ride.status) {
                case 'pending':
                    statusText = 'Aguardando aceita√ß√£o de um piloto...';
                    iconClass = 'fas fa-spinner fa-spin';
                    title = 'Buscando Piloto';
                    break;
                case 'accepted':
                    statusText = `Piloto ${ride.driverName} aceitou sua corrida!`;
                    iconClass = 'fas fa-check-circle';
                    title = 'Corrida Aceita';
                    
                    if (ride.driverName && ride.driverPhone) {
                        driverContactName.textContent = ride.driverName;
                        driverPhoneNumber.textContent = ride.driverPhone;
                        whatsappSection.style.display = 'block';
                        
                        const whatsappUrl = createWhatsAppUrl(ride.driverPhone, ride.driverName, 'passageiro');
                        whatsappPassengerBtn.href = whatsappUrl;
                        callPassengerBtn.href = `tel:${ride.driverPhone.replace(/\D/g, '')}`;
                    }
                    
                    // Show notification to passenger with WhatsApp option
                    showMobileNotification({
                        title: 'Corrida Aceita!',
                        message: `Piloto ${ride.driverName} aceitou sua corrida. Telefone: ${ride.driverPhone || 'N√£o informado'}`,
                        type: 'ride-accepted',
                        driverName: ride.driverName,
                        driverPhone: ride.driverPhone,
                        actions: ride.driverPhone ? [
                            {
                                text: 'WhatsApp',
                                type: 'whatsapp',
                                phone: ride.driverPhone,
                                name: ride.driverName,
                                role: 'passageiro'
                            },
                            {
                                text: 'Ver',
                                type: 'view'
                            }
                        ] : [
                            {
                                text: 'Ver',
                                type: 'view'
                            }
                        ]
                    });
                    break;
                case 'started':
                    statusText = `Piloto ${ride.driverName} iniciou a corrida!`;
                    iconClass = 'fas fa-motorcycle';
                    title = 'Corrida em Andamento';
                    
                    // Keep WhatsApp section visible
                    if (ride.driverName && ride.driverPhone) {
                        driverContactName.textContent = ride.driverName;
                        driverPhoneNumber.textContent = ride.driverPhone;
                        whatsappSection.style.display = 'block';
                    }
                    
                    // Show notification to passenger
                    showMobileNotification({
                        title: 'Corrida Iniciada!',
                        message: `Piloto ${ride.driverName} iniciou a corrida.`,
                        type: 'ride-started'
                    });
                    break;
                case 'completed':
                    statusText = 'Corrida finalizada com sucesso!';
                    iconClass = 'fas fa-flag-checkered';
                    title = 'Corrida Conclu√≠da';
                    
                    // Hide WhatsApp section when ride is completed
                    whatsappSection.style.display = 'none';
                    
                    // Show notification to passenger
                    showMobileNotification({
                        title: 'Corrida Conclu√≠da!',
                        message: `Sua corrida foi finalizada com sucesso. Valor: R$ ${ride.price}`,
                        type: 'success'
                    });
                    break;
                case 'cancelled':
                    statusText = 'Corrida cancelada.';
                    iconClass = 'fas fa-times-circle';
                    title = 'Corrida Cancelada';
                    
                    // Hide WhatsApp section when ride is cancelled
                    whatsappSection.style.display = 'none';
                    break;
            }
            
            rideStatusIcon.className = iconClass;
            rideStatusTitle.textContent = title;
            
            rideDetails.innerHTML = `
                <div class="ride-details">
                    <div class="ride-detail-item">
                        <span><strong>Partida:</strong></span>
                        <span>${ride.pickup}</span>
                    </div>
                    <div class="ride-detail-item">
                        <span><strong>Destino:</strong></span>
                        <span>${ride.destination}</span>
                    </div>
                    <div class="ride-detail-item">
                        <span><strong>Valor:</strong></span>
                        <span>R$ ${ride.price}</span>
                    </div>
                    ${ride.driverName ? `
                    <div class="ride-detail-item">
                        <span><strong>Piloto:</strong></span>
                        <span>${ride.driverName}</span>
                    </div>
                    <div class="ride-detail-item">
                        <span><strong>Telefone do Piloto:</strong></span>
                        <span>${ride.driverPhone || 'N√£o informado'}</span>
                    </div>
                    <div class="ride-detail-item">
                        <span><strong>Status:</strong></span>
                        <span style="color: ${getStatusColor(ride.status)}">${getStatusText(ride.status)}</span>
                    </div>
                    ` : ''}
                </div>
            `;
            
            const cancelBtn = document.getElementById('cancelRideBtn');
            if (ride.status === 'pending') {
                cancelBtn.style.display = 'inline-block';
            } else {
                cancelBtn.style.display = 'none';
            }
        }

        // Show driver active ride with WhatsApp section
        function showDriverActiveRide(ride) {
            const activeRide = document.getElementById('activeRide');
            const activeRideDetails = document.getElementById('activeRideDetails');
            const startRideBtn = document.getElementById('startRideBtn');
            const completeRideBtn = document.getElementById('completeRideBtn');
            
            activeRide.style.display = 'block';
            
            activeRideDetails.innerHTML = `
                <div class="ride-details">
                    <div class="ride-detail-item">
                        <span><strong>Passageiro:</strong></span>
                        <span>${ride.passengerName}</span>
                    </div>
                    <div class="ride-detail-item">
                        <span><strong>Telefone:</strong></span>
                        <span>${ride.passengerPhone || 'N√£o informado'}</span>
                    </div>
                    <div class="ride-detail-item">
                        <span><strong>Partida:</strong></span>
                        <span>${ride.pickup}</span>
                    </div>
                    <div class="ride-detail-item">
                        <span><strong>Destino:</strong></span>
                        <span>${ride.destination}</span>
                    </div>
                    <div class="ride-detail-item">
                        <span><strong>Valor:</strong></span>
                        <span>R$ ${ride.price}</span>
                    </div>
                    <div class="ride-detail-item">
                        <span><strong>Status:</strong></span>
                        <span style="color: ${getStatusColor(ride.status)}">${getStatusText(ride.status)}</span>
                    </div>
                </div>
            `;
            
            if (ride.status === 'accepted' || ride.status === 'started') {
                if (ride.passengerName && ride.passengerPhone) {
                    passengerContactName.textContent = ride.passengerName;
                    passengerPhoneNumber.textContent = ride.passengerPhone;
                    whatsappDriverSection.style.display = 'block';
                    
                    const whatsappUrl = createWhatsAppUrl(ride.passengerPhone, ride.passengerName, 'piloto');
                    whatsappDriverBtn.href = whatsappUrl;
                    callDriverBtn.href = `tel:${ride.passengerPhone.replace(/\D/g, '')}`;
                }
            } else {
                whatsappDriverSection.style.display = 'none';
            }
            
            if (ride.status === 'accepted') {
                startRideBtn.style.display = 'inline-block';
                completeRideBtn.style.display = 'none';
            } else if (ride.status === 'started') {
                startRideBtn.style.display = 'none';
                completeRideBtn.style.display = 'inline-block';
            }
            
            document.getElementById('activeRideRequests').style.display = 'none';
        }

        // Create WhatsApp URL
        function createWhatsAppUrl(phone, name, role) {
            let formattedPhone = phone.replace(/\D/g, '');
            
            if (!formattedPhone.startsWith('55') && formattedPhone.length <= 11) {
                formattedPhone = '55' + formattedPhone;
            }
            
            let message = '';
            if (role === 'passageiro') {
                message = `Ol√° ${name}! Sou seu passageiro do MotoZap. Podemos combinar os detalhes da corrida?`;
            } else {
                message = `Ol√° ${name}! Sou seu piloto do MotoZap. Estou a caminho para busc√°-lo.`;
            }
            
            const encodedMessage = encodeURIComponent(message);
            return `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
        }

        // Load passenger ride history
        async function loadPassengerHistory(userId) {
            try {
                const historySnapshot = await database.ref('rides').orderByChild('passengerId').equalTo(userId).once('value');
                const history = historySnapshot.val();
                
                const historyList = document.getElementById('historyList');
                const noHistoryMessage = document.getElementById('noHistoryMessage');
                
                if (history) {
                    noHistoryMessage.style.display = 'none';
                    historyList.style.display = 'block';
                    historyList.innerHTML = '';
                    
                    Object.keys(history).forEach(key => {
                        const ride = history[key];
                        const rideElement = document.createElement('div');
                        rideElement.className = 'driver-card';
                        rideElement.innerHTML = `
                            <p><strong>De:</strong> ${ride.pickup}</p>
                            <p><strong>Para:</strong> ${ride.destination}</p>
                            <p><strong>Piloto:</strong> ${ride.driverName || 'Aguardando'}</p>
                            <p><strong>Valor:</strong> R$ ${ride.price || '0,00'}</p>
                            <p><strong>Status:</strong> <span style="color: ${getStatusColor(ride.status)}">${getStatusText(ride.status)}</span></p>
                            <p><strong>Data:</strong> ${new Date(ride.createdAt).toLocaleDateString('pt-BR')}</p>
                        `;
                        historyList.appendChild(rideElement);
                    });
                } else {
                    noHistoryMessage.style.display = 'block';
                    historyList.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading passenger history:', error);
            }
        }

        // Load driver ride history
        async function loadDriverHistory(userId) {
            try {
                const historySnapshot = await database.ref('rides').orderByChild('driverId').equalTo(userId).once('value');
                const history = historySnapshot.val();
                
                const driverHistoryList = document.getElementById('driverHistoryList');
                const driverNoHistoryMessage = document.getElementById('driverNoHistoryMessage');
                
                if (history) {
                    driverNoHistoryMessage.style.display = 'none';
                    driverHistoryList.style.display = 'block';
                    driverHistoryList.innerHTML = '';
                    
                    Object.keys(history).forEach(key => {
                        const ride = history[key];
                        const rideElement = document.createElement('div');
                        rideElement.className = 'driver-card';
                        rideElement.innerHTML = `
                            <p><strong>Passageiro:</strong> ${ride.passengerName}</p>
                            <p><strong>Rota:</strong> ${ride.pickup} ‚Üí ${ride.destination}</p>
                            <p><strong>Valor:</strong> R$ ${ride.price || '0,00'}</p>
                            <p><strong>Status:</strong> <span style="color: ${getStatusColor(ride.status)}">${getStatusText(ride.status)}</span></p>
                            <p><strong>Data:</strong> ${new Date(ride.createdAt).toLocaleDateString('pt-BR')}</p>
                        `;
                        driverHistoryList.appendChild(rideElement);
                    });
                } else {
                    driverNoHistoryMessage.style.display = 'block';
                    driverHistoryList.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading driver history:', error);
            }
        }

        // Helper functions
        function getStatusColor(status) {
            switch(status) {
                case 'pending': return '#FF9900';
                case 'accepted': return '#0a5c36';
                case 'started': return '#2c5282';
                case 'completed': return '#0a5c36';
                case 'cancelled': return '#dc3545';
                default: return '#666';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'Pendente';
                case 'accepted': return 'Aceita';
                case 'started': return 'Em Andamento';
                case 'completed': return 'Conclu√≠da';
                case 'cancelled': return 'Cancelada';
                default: return status;
            }
        }

        // Ride request functionality
        document.getElementById('requestRideBtn')?.addEventListener('click', async () => {
            const pickup = document.getElementById('pickupLocation').value;
            const destination = document.getElementById('destination').value;
            const price = document.getElementById('ridePrice').value;
            
            if (!pickup || !destination) {
                showMobileNotification({
                    title: 'Erro',
                    message: 'Por favor, preencha os campos de partida e destino.',
                    type: 'error'
                });
                return;
            }
            
            if (!price || price < 5) {
                showMobileNotification({
                    title: 'Erro',
                    message: 'Por favor, informe um valor m√≠nimo de R$ 5,00.',
                    type: 'error'
                });
                return;
            }
            
            try {
                const rideData = {
                    passengerId: currentUser.uid,
                    passengerName: currentUser.name,
                    passengerPhone: currentUser.phone,
                    pickup: pickup,
                    destination: destination,
                    price: parseFloat(price).toFixed(2),
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                const newRideRef = database.ref('rides').push();
                await newRideRef.set(rideData);
                
                currentRideId = newRideRef.key;
                
                updatePassengerRideStatus(rideData);
                loadPassengerHistory(currentUser.uid);
                
                showMobileNotification({
                    title: 'Corrida Solicitada!',
                    message: 'Aguarde um piloto aceitar sua corrida.',
                    type: 'success'
                });
                
                // Notificar motoristas dispon√≠veis
                const availableDrivers = await getAvailableDrivers();
                for (const driver of availableDrivers) {
                    await sendPushNotification(driver.uid, {
                        title: 'Nova Corrida Dispon√≠vel!',
                        body: `${currentUser.name} solicitou uma corrida de ${pickup} para ${destination} por R$ ${price}`,
                        data: {
                            type: 'new-ride',
                            rideId: newRideRef.key,
                            passengerName: currentUser.name,
                            passengerPhone: currentUser.phone,
                            pickup: pickup,
                            destination: destination,
                            price: price
                        }
                    });
                }
                
            } catch (error) {
                console.error('Error requesting ride:', error);
                showMobileNotification({
                    title: 'Erro',
                    message: 'Erro ao solicitar corrida. Tente novamente.',
                    type: 'error'
                });
            }
        });

        // Get available drivers
        async function getAvailableDrivers() {
            try {
                const driversSnapshot = await database.ref('drivers')
                    .orderByChild('available')
                    .equalTo(true)
                    .once('value');
                
                const drivers = driversSnapshot.val();
                const availableDrivers = [];
                
                if (drivers) {
                    Object.keys(drivers).forEach(driverId => {
                        if (driverId !== currentUser.uid) {
                            availableDrivers.push({
                                uid: driverId,
                                ...drivers[driverId]
                            });
                        }
                    });
                }
                
                return availableDrivers;
            } catch (error) {
                console.error('Erro ao obter motoristas dispon√≠veis:', error);
                return [];
            }
        }

        // Cancel ride for passenger
        document.getElementById('cancelRideBtn')?.addEventListener('click', async () => {
            if (!currentRideId) return;
            
            if (confirm('Tem certeza que deseja cancelar esta corrida?')) {
                try {
                    await database.ref('rides/' + currentRideId).update({
                        status: 'cancelled',
                        cancelledAt: new Date().toISOString()
                    });
                    
                    // Make driver available again if there was one
                    const rideSnapshot = await database.ref('rides/' + currentRideId).once('value');
                    const ride = rideSnapshot.val();
                    
                    if (ride && ride.driverId) {
                        await database.ref('drivers/' + ride.driverId).update({
                            available: true,
                            lastUpdate: new Date().toISOString()
                        });
                        
                        // Notificar o motorista sobre o cancelamento
                        await sendPushNotification(ride.driverId, {
                            title: 'Corrida Cancelada',
                            body: `O passageiro ${ride.passengerName} cancelou a corrida.`,
                            data: {
                                type: 'ride-cancelled',
                                passengerName: ride.passengerName
                            }
                        });
                    }
                    
                    showMobileNotification({
                        title: 'Corrida Cancelada',
                        message: 'Sua corrida foi cancelada com sucesso.',
                        type: 'info'
                    });
                    
                    loadPassengerHistory(currentUser.uid);
                    
                } catch (error) {
                    console.error('Error cancelling ride:', error);
                    showMobileNotification({
                        title: 'Erro',
                        message: 'Erro ao cancelar corrida.',
                        type: 'error'
                    });
                }
            }
        });

        // Event delegation for ride request buttons
        document.getElementById('rideRequestsList')?.addEventListener('click', async (e) => {
            const rideId = e.target.closest('button')?.dataset.rideId;
            if (!rideId) return;
            
            const rideSnapshot = await database.ref('rides/' + rideId).once('value');
            const ride = rideSnapshot.val();
            
            if (!ride) return;
            
            if (e.target.closest('.accept-ride-btn')) {
                try {
                    await database.ref('rides/' + rideId).update({
                        status: 'accepted',
                        driverId: currentUser.uid,
                        driverName: currentUser.name,
                        driverPhone: currentUser.phone,
                        acceptedAt: new Date().toISOString()
                    });
                    
                    await database.ref('drivers/' + currentUser.uid).update({
                        available: false,
                        lastUpdate: new Date().toISOString()
                    });
                    
                    // Show notification with WhatsApp option
                    showMobileNotification({
                        title: 'Corrida Aceita!',
                        message: `Voc√™ aceitou a corrida de ${ride.passengerName}. Telefone: ${ride.passengerPhone || 'N√£o informado'}`,
                        type: 'ride-accepted',
                        passengerName: ride.passengerName,
                        passengerPhone: ride.passengerPhone,
                        actions: ride.passengerPhone ? [
                            {
                                text: 'WhatsApp',
                                type: 'whatsapp',
                                phone: ride.passengerPhone,
                                name: ride.passengerName,
                                role: 'piloto'
                            },
                            {
                                text: 'Ver',
                                type: 'view'
                            }
                        ] : [
                            {
                                text: 'Ver',
                                type: 'view'
                            }
                        ]
                    });
                    
                    // Enviar notifica√ß√£o para o passageiro
                    await sendPushNotification(ride.passengerId, {
                        title: 'Corrida Aceita!',
                        body: `Piloto ${currentUser.name} aceitou sua corrida. Telefone: ${currentUser.phone}`,
                        data: {
                            type: 'ride-accepted',
                            driverName: currentUser.name,
                            driverPhone: currentUser.phone,
                            role: 'passageiro'
                        }
                    });
                    
                } catch (error) {
                    console.error('Error accepting ride:', error);
                    showMobileNotification({
                        title: 'Erro',
                        message: 'Erro ao aceitar corrida.',
                        type: 'error'
                    });
                }
                
            } else if (e.target.closest('.decline-ride-btn')) {
                if (confirm('Recusar esta corrida?')) {
                    try {
                        await database.ref('rides/' + rideId).update({
                            status: 'cancelled',
                            cancelledAt: new Date().toISOString(),
                            cancelledBy: 'driver'
                        });
                        
                        showMobileNotification({
                            title: 'Corrida Recusada',
                            message: 'Voc√™ recusou a corrida.',
                            type: 'info'
                        });
                        
                        // Notificar o passageiro
                        await sendPushNotification(ride.passengerId, {
                            title: 'Corrida Recusada',
                            body: 'Infelizmente um piloto recusou sua corrida. Por favor, solicite novamente.',
                            data: {
                                type: 'ride-declined'
                            }
                        });
                        
                    } catch (error) {
                        console.error('Error declining ride:', error);
                        showMobileNotification({
                            title: 'Erro',
                            message: 'Erro ao recusar corrida.',
                            type: 'error'
                        });
                    }
                }
            }
        });

        // Start ride for driver
        document.getElementById('startRideBtn')?.addEventListener('click', async () => {
            if (!currentRideId) return;
            
            try {
                await database.ref('rides/' + currentRideId).update({
                    status: 'started',
                    startedAt: new Date().toISOString()
                });
                
                showMobileNotification({
                    title: 'Corrida Iniciada!',
                    message: 'Voc√™ iniciou a corrida.',
                    type: 'ride-started'
                });
                
                // Notificar o passageiro
                const rideSnapshot = await database.ref('rides/' + currentRideId).once('value');
                const ride = rideSnapshot.val();
                
                if (ride) {
                    await sendPushNotification(ride.passengerId, {
                        title: 'Corrida Iniciada!',
                        body: `Piloto ${currentUser.name} iniciou a corrida.`,
                        data: {
                            type: 'ride-started',
                            driverName: currentUser.name
                        }
                    });
                }
                
            } catch (error) {
                console.error('Error starting ride:', error);
                showMobileNotification({
                    title: 'Erro',
                    message: 'Erro ao iniciar corrida.',
                    type: 'error'
                });
            }
        });

        // Complete ride for driver
        document.getElementById('completeRideBtn')?.addEventListener('click', async () => {
            if (!currentRideId) return;
            
            if (confirm('Confirmar finaliza√ß√£o da corrida?')) {
                try {
                    await database.ref('rides/' + currentRideId).update({
                        status: 'completed',
                        completedAt: new Date().toISOString()
                    });
                    
                    await database.ref('drivers/' + currentUser.uid).update({
                        available: true,
                        lastUpdate: new Date().toISOString()
                    });
                    
                    // Update driver stats
                    const driverSnapshot = await database.ref('drivers/' + currentUser.uid).once('value');
                    const driverData = driverSnapshot.val();
                    const newTotalRides = (driverData.totalRides || 0) + 1;
                    
                    await database.ref('drivers/' + currentUser.uid).update({
                        totalRides: newTotalRides
                    });
                    
                    document.getElementById('activeRide').style.display = 'none';
                    whatsappDriverSection.style.display = 'none';
                    
                    showMobileNotification({
                        title: 'Corrida Conclu√≠da!',
                        message: `Corrida finalizada com sucesso!`,
                        type: 'success'
                    });
                    
                    // Notificar o passageiro
                    const rideSnapshot = await database.ref('rides/' + currentRideId).once('value');
                    const ride = rideSnapshot.val();
                    
                    if (ride) {
                        await sendPushNotification(ride.passengerId, {
                            title: 'Corrida Conclu√≠da!',
                            body: `Sua corrida foi finalizada com sucesso. Valor: R$ ${ride.price}`,
                            data: {
                                type: 'ride-completed',
                                price: ride.price
                            }
                        });
                    }
                    
                    loadDriverHistory(currentUser.uid);
                    setupDriverAvailability(currentUser.uid);
                    
                    document.getElementById('activeRideRequests').style.display = 'block';
                    
                } catch (error) {
                    console.error('Error completing ride:', error);
                    showMobileNotification({
                        title: 'Erro',
                        message: 'Erro ao finalizar corrida.',
                        type: 'error'
                    });
                }
            }
        });

        // Cancel active ride for driver
        document.getElementById('cancelActiveRideBtn')?.addEventListener('click', async () => {
            if (!currentRideId) return;
            
            if (confirm('Cancelar esta corrida?')) {
                try {
                    const rideSnapshot = await database.ref('rides/' + currentRideId).once('value');
                    const ride = rideSnapshot.val();
                    
                    await database.ref('rides/' + currentRideId).update({
                        status: 'cancelled',
                        cancelledAt: new Date().toISOString(),
                        cancelledBy: 'driver'
                    });
                    
                    await database.ref('drivers/' + currentUser.uid).update({
                        available: true,
                        lastUpdate: new Date().toISOString()
                    });
                    
                    document.getElementById('activeRide').style.display = 'none';
                    whatsappDriverSection.style.display = 'none';
                    
                    showMobileNotification({
                        title: 'Corrida Cancelada',
                        message: 'Voc√™ cancelou a corrida.',
                        type: 'info'
                    });
                    
                    // Notificar o passageiro
                    if (ride) {
                        await sendPushNotification(ride.passengerId, {
                            title: 'Corrida Cancelada',
                            body: `O piloto ${currentUser.name} cancelou a corrida.`,
                            data: {
                                type: 'ride-cancelled',
                                driverName: currentUser.name
                            }
                        });
                    }
                    
                    setupDriverAvailability(currentUser.uid);
                    document.getElementById('activeRideRequests').style.display = 'block';
                    
                } catch (error) {
                    console.error('Error cancelling active ride:', error);
                    showMobileNotification({
                        title: 'Erro',
                        message: 'Erro ao cancelar corrida.',
                        type: 'error'
                    });
                }
            }
        });
    </script>
</body>
</html>